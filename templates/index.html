{% extends 'base.html' %}

{% block title %}
    Financial Analysis Dashboard {% if stock %}- {{ stock }}{% endif %}
{% endblock %}

{% block content %}
    {# Check if a stock symbol is actively being displayed #}
    {% if stock %}
        {# Include the header specific to the selected stock #}
        {# It requires 'stock', 'stock_data', and 'decision' variables #}
        {% include 'partials/_dashboard_header.html' %}

        {# Display a prominent error message if stock data fetching failed #}
        {% if error %}
             <div class="alert alert-danger mt-3" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Error:</strong>
              {# Display the specific error message from the backend #}
              {% if error_message %}
                  {{ error_message }} Please check the symbol or try again later.
              {% else %}
                  There was a problem loading data for {{ stock }}.
              {% endif %}
            </div>
        {% endif %}

        {# Main Tab Content Area - Only show tabs if there wasn't a complete data loading failure #}
        {# We might still show tabs even if only news failed, hence check for stock_data existence #}
        {# If stock_data is None due to error, overview will show its own error message #}
         <div class="tab-content mt-3" id="dashboardTabContent">

            <!-- Overview Tab Pane -->
            {# This tab needs 'stock_data' and 'tech_indicators' #}
            {# It also implicitly uses 'error' and 'error_message' for its internal display logic #}
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                {% include 'tabs/overview.html' %}
            </div>

            <!-- News Tab Pane -->
            {# This tab needs 'articles' and potentially 'now' for date formatting #}
             {# Also pass 'error_message' to show if news loading failed #}
            <div class="tab-pane fade" id="news" role="tabpanel" aria-labelledby="news-tab">
                {% include 'tabs/news.html' %}
            </div>

            <!-- Details Tab Pane (Content moved to Overview) -->
            {# This tab primarily shows a message now #}
            <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
                 {% include 'tabs/details.html' %} {# Include the placeholder message #}
            </div>

            <!-- Forecasting Tab Pane -->
            {# This tab primarily relies on AJAX calls triggered by forecast.js #}
            {# Pass the stock symbol for AJAX calls #}
            {# Initial state can show loading or prompt based on JS logic #}
            <div class="tab-pane fade" id="forecasting" role="tabpanel" aria-labelledby="forecasting-tab">
                 {# Include the forecast template structure. JS will handle loading. #}
                 {# Pass stock symbol needed for JS #}
                 {% include 'tabs/forecast.html' %}
                 {# Note: Removed forecast_data, decision_data, sentiment_data from here as they are loaded via AJAX #}
            </div>

        </div> {# End .tab-content #}

    {% else %}
        {# No stock symbol selected, show the welcome screen #}
        {% include 'partials/_welcome.html' %}
    {% endif %} {# End if stock #}
{% endblock %}

{% block scripts %}
    {# Include the script that initializes the global window.stockData variable #}
    <script src="{{ url_for('static', filename='js/stock-data-loader.js') }}"></script>

    {# Pass data from Flask to JavaScript using data attributes instead of embedding Jinja in JS #}
    <div id="flask-data" 
        data-stock="{% if stock %}{{ stock }}{% else %}{% endif %}"
        data-has-error="{% if error %}true{% else %}false{% endif %}"
        style="display:none;">
    </div>

    {% if stock_data and not error %}
    <script id="stock-data-json" type="application/json">
        {{ stock_data | safe }}
    </script>
    {% endif %}
    
    {# Now use those data attributes in pure JavaScript #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("index.html: DOMContentLoaded - Initializing window.stockData");
        
        // Get data from the hidden div element
        const dataElement = document.getElementById('flask-data');
        const stockSymbol = dataElement.dataset.stock || null;
        const hasError = dataElement.dataset.hasError === 'true';
        
        // Get stock data from the JSON script tag if it exists
        let initialStockData = null;
        const stockDataScript = document.getElementById('stock-data-json');
        if (stockDataScript) {
            try {
                initialStockData = JSON.parse(stockDataScript.textContent);
            } catch (e) {
                console.error("Error parsing stock data JSON:", e);
            }
        }
        
        if (initialStockData && !hasError) {
            try {
                // Use the initializer function from stock-data-loader.js
                initializeStockData(initialStockData);
            } catch (e) {
                console.error("Error processing initial stock data:", e);
                // Set to null if processing fails
                setEmptyStockData();
                // Optionally show a flash message about the data issue
                showFlashMessage("Failed to load initial stock data structure.", "danger");
            }
        } else if (hasError) {
            // If Flask reported an error, ensure JS knows there's no valid data
            console.warn("index.html: Flask reported an error, setting empty stock data.");
            setEmptyStockData();
        } else {
            // No stock selected or other case where stock_data is not available
            console.log("index.html: No initial stock data passed from Flask.");
            setEmptyStockData();
        }

        // Trigger forecast load if forecast tab exists and stock symbol is present
        // Note: forecast.js now handles its own loading based on symbol, this might be redundant
        /*
        const forecastTab = document.getElementById('forecasting');
        if (forecastTab && stockSymbol) {
            console.log("index.html: Triggering initial forecast load for " + stockSymbol);
            loadForecastData(stockSymbol); // Assuming loadForecastData is globally available from forecast.js
        }
        */
    });
    </script>
{% endblock %}